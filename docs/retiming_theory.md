# Retiming 理論說明

Retiming 是一種數位電路優化技術，它透過在組合邏輯路徑中移動寄存器（flip-flops）的位置，來改善電路的時序特性，例如縮短關鍵路徑延遲、提高時脈頻率或減少功耗，同時保持電路原有的功能不變。

## 核心概念

1.  **關鍵路徑 (Critical Path):** 電路中延遲最長的路徑，它決定了電路可以運行的最高時脈頻率。
2.  **組合邏輯 (Combinational Logic):** 輸出僅由目前輸入決定的邏輯電路，不包含任何記憶元件。
3.  **時序邏輯 (Sequential Logic):** 輸出不僅取決於目前輸入，也取決於過去的狀態（儲存在寄存器中）。
4.  **流水線 (Pipelining):** 一種將長的組合邏輯路徑分割成多個較短的階段，並在階段之間插入寄存器的技術。每個階段可以在一個時脈週期內完成，從而提高整體吞吐量和時脈頻率。Retiming 可以被視為一種廣義的流水線技術。

## Retiming 的數學模型

電路通常可以被模型化為一個有向圖 \(G = (V, E)\)，其中：

*   \(V\) 是節點的集合，代表邏輯閘或寄存器。
*   \(E\) 是邊的集合，代表節點之間的連接。

每個節點 \(v\) 有一個延遲 \(d(v)\)。每條邊 \((u, v)\) 有一個權重 \(w(u, v)\)，代表從節點 \(u\) 的輸出到節點 \(v\) 的輸入之間的寄存器數量。

Retiming 操作是為圖中的每個節點 \(v\) 分配一個整數標籤 \(r(v)\)。這個標籤代表從該節點的輸出端"借用"或"移動"寄存器的數量。如果 \(r(v)\) 為正，則表示將 \(r(v)\) 個寄存器從節點 \(v\) 的每個輸出邊移動到其每個輸入邊。如果 \(r(v)\) 為負，則表示將 \(|r(v)|\) 個寄存器從節點 \(v\) 的每個輸入邊移動到其每個輸出邊。

Retiming 後，新的邊權重 \(w_r(u, v)\) 計算如下：
\[ w_r(u, v) = w(u, v) + r(v) - r(u) \]

## Retiming 的目標和约束

1.  **保持功能不變：** Retiming 過程中，輸入到輸出的總寄存器數量在任何路徑上都必須保持非負，即 \(w_r(u, v) \ge 0\) 對於所有的邊。
2.  **滿足時序要求：** 關鍵路徑延遲 \( \Phi(G_r) \) 必須小於或等於目標時脈週期 \(c\)。關鍵路徑是圖中所有寄存器之間組合邏輯延遲最長的路徑。

## Retiming 的優點

*   **提高時脈頻率：** 透過縮短關鍵路徑，可以讓電路在更高的時脈 fréquence 下運作。
*   **降低功耗：** 雖然增加寄存器可能會增加時脈功耗，但透過平衡路徑延遲和減少毛刺 (glitches)，可以潛在地降低整體動態功耗。
*   **面積優化：** 在某些情況下，Retiming 甚至可以減少所需的寄存器總數。

## Retiming 在 FIR 濾波器中的應用

在 FIR 濾波器中，主要的運算單元是乘法累加器 (MAC)。一個直接形式 (Direct Form) 的 FIR 濾波器結構如下：

輸入 \(x(n)\) 經過一系列延遲單元 (D)，每個延遲後的訊號與對應的濾波器係數 \(b_k\) 相乘，然後所有乘積加總得到輸出 \(y(n)\)。
\[ y(n) = \sum_{k=0}^{N-1} b_k \cdot x(n-k) \]
其中 \(N\) 是濾波器的階數 (taps)。

在這個結構中，乘法和累加操作通常在同一個時脈週期內完成。如果濾波器的階數很高，那麼一長串的加法器就會形成一個很長的組合邏輯路徑，成為時序瓶頸。

Retiming 可以用來解決這個問題：

1.  **在 MAC 單元內部進行 Retiming：** 例如，可以將乘法和加法操作分割到不同的流水線階段。
2.  **在 FIR 結構級別進行 Retiming：** 可以重新分佈延遲單元 (寄存器) 的位置，以平衡不同路徑之間的延遲。例如，可以將一些延遲從輸入路徑移動到累加路徑中，或者反過來。這類似於將直接形式 (Direct Form) 轉換為轉置形式 (Transpose Form)，或者其他具有更好時序特性的結構。

    轉置形式 (Transpose Form) 的 FIR 結構天然地將加法操作分佈在寄存器之間，這通常具有較好的時序特性，因為累加路徑上的組合邏輯延遲較短。

## 本專案中的 Retiming 目標

*   **降低關鍵路徑延遲：** 特別是針對傳統 FIR 濾波器中 MAC 單元造成的長組合路徑。
*   **提升系統工作頻率：** 透過寄存器的重新配置，縮短時脈週期，使系統能在更高頻率下穩定工作。
*   **優化功耗特性：** 減少長組合路徑中的切換活動，有助於降低動態功耗。 